# 技术笔记与经验记录

本文档记录 ADOC Skill 使用过程中的经验、常见问题和解决方案。

---

## 1. 状态检测问题

### 问题：如何判断 intent.md 是否"完整"

**场景**：用户创建了 intent.md 但只写了标题，或者内容是模板占位符。

**解决方案**：
检查以下条件：
1. 文件是否存在
2. 文件内容是否超过 100 字符
3. 是否包含四个核心要素的关键词（Why/Who/Success/Non-Goals）

```bash
# 检测示例
content=$(cat _adoc/intent.md 2>/dev/null)
length=${#content}

if [ $length -lt 100 ]; then
  echo "内容不完整：太短"
elif ! echo "$content" | grep -q "Why\|核心动机"; then
  echo "内容不完整：缺少 Why 部分"
fi
```

### 问题：plan/ 目录下如何区分进行中和已归档

**解决方案**：
- 进行中：文件名以 `v` 开头，如 `v0.2-search.md`
- 已归档：文件名以 `archived-` 开头，如 `archived-v0.1-init.md`

```bash
# 找进行中的 plan
ls _adoc/plan/ | grep -v "^archived-"

# 找已归档的 plan
ls _adoc/plan/ | grep "^archived-"
```

---

## 1.5 初始化阶段的抽象化问题（重要！）

### 问题：AI 生成的 Intent 过于具体

**场景**：用户在初始化对话中给出具体描述（如"Dify 不管 Prompt 版本""3-5 人团队"），AI 直接接受并写入 Intent，导致文档绑定了具体工具、团队规模等实现细节。

**根本原因**：
1. AI 倾向于接受用户的具体表达，没有主动"上提抽象"
2. 缺少明确的"抽象化引导"步骤
3. 追问策略错误：在 Intent 阶段追问 spec 层面的问题（如"与 Dify 如何集成"）

**解决方案**：
在"阶段 1: 初始化"中增加"步骤 3: 抽象化引导"：

1. **识别具体化信号**：
   - 具体工具名称（Dify、GPT-4）
   - 具体功能（版本管理、一键验证）
   - 数据结构（v1/v2/v3）
   - 团队规模（3-5 人）
   - 部署方式（不做登录）

2. **抽象化策略**：
   ```
   用户：Dify 只管工作流，不管 Prompt 版本
   AI：现有工作流工具把 Prompt 当配置，缺乏工程化能力

   用户：需要版本管理
   AI：需要让 Prompt 像代码一样可追溯、可验证

   用户：3-5 人团队
   AI：面向小团队协作场景
   ```

3. **延迟具体化**：
   - ❌ 不在 Intent 阶段问"与 Dify 如何集成"
   - ❌ 不在 Intent 阶段问"案例的数据结构"
   - ❌ 不在 Intent 阶段问"是否需要登录"
   - ✅ 这些问题应该在 business/tech 阶段再问

4. **抽象检验清单**：
   生成 Intent 前必须检查：
   - [ ] Why 是否绑定了具体工具名称？
   - [ ] Who 是否限定了团队规模/职位？
   - [ ] Success 是否描述功能而非价值？
   - [ ] Non-Goals 是否混入实现细节？
   - [ ] 是否出现数据模型、操作流程？

**反面案例（真实案例）**：
```markdown
❌ 错误的 Intent：
- "我们使用 Dify 平台管理工作流"
- "小团队（3-5 人）"
- "不做登录功能"
- "附录：核心数据模型"

✅ 正确的 Intent：
- "现有工作流工具缺乏 Prompt 工程化能力"
- "小团队协作场景"
- "不做复杂权限管理"
- 不应出现数据模型
```

---

## 2. 文档结构问题

### 问题：Spec 的粒度如何把握

**经验总结**：

| 信号 | 说明 | 处理方式 |
|------|------|---------|
| 文档超过 3 页 | 粒度太大 | 拆分成多个 spec |
| 包含多个独立用户旅程 | 粒度太大 | 拆分 |
| 验收标准只有 1-2 条 | 粒度太小 | 合并到相关 spec |
| 必须和另一个 spec 一起才有意义 | 粒度太小 | 合并 |

**合适的粒度**：
- 一个明确的核心能力
- 2-5 个相关的用户旅程
- 4-8 条验收标准
- 1-2 页内容

### 问题：tech/ 应该包含什么

**经验总结**：

tech/ 是研发层面的约束，不是功能描述。

**应该包含**：
- 技术栈选型（框架、数据库、语言）
- 系统分层（架构图、边界规则）
- 工程规范（目录职责、样式约定）
- 性能红线（响应时间、并发限制）

**不应该包含**：
- 功能描述（放 business/ 各模块）
- 迭代计划（放 plan/）
- 业务逻辑（放 business/ 各模块）

---

## 3. 工作流问题

### 问题：用户想跳过某个阶段

**场景**：用户在阶段 1（定方向）时说"我方向已经想好了，直接帮我写 intent.md"。

**处理方式**：
1. 确认用户的方向描述
2. 帮助提炼四个要素
3. 生成 intent.md
4. 跳转到下一阶段

不要强制用户走完整的对话流程。

### 问题：用户想同时处理多个阶段

**场景**：用户说"帮我把 intent 和 spec 都写了"。

**处理方式**：
1. 可以连续执行多个阶段
2. 但每个阶段完成后要确认
3. 不要一次性生成所有文档（容易出错）

### 问题：用户中途离开，如何恢复

**场景**：用户在写 spec 写到一半时离开了。

**处理方式**：
1. 下次调用 /adoc 时自动检测状态
2. 展示当前进度
3. 询问是否继续

关键是让文档状态可检测、可恢复。

---

## 4. 文档同步问题

### 问题：代码和文档不一致

**场景**：开发过程中发现 spec 写的有问题，但代码已经按正确的方式实现了。

**处理方式**：
1. 完成当前任务
2. 回写更新 spec
3. 在 plan 归档前确认所有文档已同步

### 问题：plan 中的任务完成了但忘记标记

**处理方式**：
在"阶段 4: 执行计划"中，AI 会主动检查代码进度：
1. 扫描相关文件
2. 判断任务是否已完成
3. 提示用户同步文档

---

## 5. 边界情况

### 问题：空项目调用 /adoc

**处理**：检测到无 `_adoc/` 目录，进入阶段 1（初始化）。

### 问题：有 _adoc/ 但里面是空的

**处理**：同上，视为新项目。

### 问题：有多个进行中的 plan

**处理**：
1. 列出所有进行中的 plan
2. 询问用户要继续哪个
3. 建议用户归档不需要的 plan

### 问题：用户想删除某个 spec

**处理**：
1. 重命名为 `archived-xxx.md`
2. 或直接删除（如果确认不需要历史）
3. 检查是否有 plan 依赖这个 spec

---

## 6. 最佳实践

### 文档命名

```
# Intent
intent.md（唯一）

# Spec → 放在 business/ 各模块内部
business/docs/spec-translation.md
business/search/spec-search.md

# Tech → 放在 tech/ 各项目内部
tech/astro/README.md
tech/astro/routing.md

# Plan
v0.1-init.md
v0.2-search.md
archived-v0.1-init.md
```

### 每次对话的结构

1. 状态检测（阶段 0）
2. 展示当前状态
3. 推荐下一步操作
4. 用户确认或选择其他
5. 执行对应阶段
6. 更新文档
7. 提示下一步

### 文档更新时机

| 时机 | 更新的文档 |
|------|-----------|
| 方向确定 | intent.md |
| 功能设计完成 | business/xxx/spec-xxx.md |
| 计划创建 | plan/vX.Y-xxx.md |
| 任务完成 | plan 中标记 [x] |
| 计划完成 | plan 重命名 archived- |
| 发现需要修正 | 对应的 business/ 或 tech/ 文档 |

---

## 7. 已知限制

1. **不支持多人协作场景**：当前设计假设单人使用，多人同时编辑可能冲突。
2. **不支持分支**：没有像 git 那样的分支概念，所有变更都是线性的。
3. **状态检测依赖文件命名**：如果用户手动改了文件名，可能导致状态判断错误。

---

## 8. 后续改进方向

- [ ] 支持 tech/ 文档的模板化创建
- [ ] 支持业务模块之间的依赖关系可视化
- [ ] 支持 plan 的进度百分比展示
- [ ] 支持从已有代码反向生成文档骨架
